# High-Level Design – Symlink Safety | Progress Controls | Failure Surfacing
Date: 2025-11-21
Owner: Codex

## Goals
- Prevent unbounded or cyclic traversal when `--follow-symlinks` is enabled.
- Make progress timing env vars (`MDDEDUPE_SCAN_PROGRESS_MS`, `MDDEDUPE_HASH_PROGRESS_MS`) honor zero/small values to allow "disable" or faster updates.
- Ensure action failures are surfaced even when `--log-level none` and no summary file is written, avoiding silent partial actions.
- Maintain current CLI defaults, backward compatibility, and test pass.

## Scope
- Code: `src/main.rs` (walk, progress, logging, summary writing), related tests in `src/main.rs` and `tests/cli.rs`.
- Docs: mention new semantics for env vars and error surfacing nuances (readme/docs/usage) if time permits.

## Current Behavior (Problems)
1) Symlink follow uses `WalkDir::new(dir).follow_links(true)` without cycle detection → symlink loop can spin indefinitely and hash repeatedly.
2) `read_duration_from_env` filters out non-positive values → setting `MDDEDUPE_*` to `0` reverts to defaults, so users cannot disable or accelerate progress output.
3) With `--log-level none` and no `--summary-path`, action failures are only stored in `summary_lines` (not printed), so runs can finish silently despite errors.

## Design Overview
- Add cross-platform cycle guard when following symlinks: track visited directory IDs; skip entries whose directory identity was already seen; degrade safely when metadata is unreadable.
- Redefine progress env semantics: `0` => disable progress output; small positive numbers are honored as-is; negative/invalid still fall back to default.
- Add failure surfacing fallback: after actions, always print a compact failure summary to stderr when any failures occurred, regardless of log level or summary flags (unless process already errored or no action was executed).

## Detailed Design
### 1) Symlink cycle protection
- Introduce a `FileId` type with platform-specific identity:
  - Unix: `(dev, ino)` via `MetadataExt::{dev, ino}`.
  - Windows: `(volume_serial_number, file_index_{high,low})` via `MetadataExt` (directory metadata is supported on stable).
  - Fallback (non-unix/win targets): normalized absolute path string (best-effort). If canonicalization fails (e.g., broken link), fall back to the raw `entry.path()` string to avoid panics and still make forward progress.
- Maintain `HashSet<FileId>` only when `follow_symlinks` is `true`.
- Integrate with `WalkDir` via `filter_entry`:
  - On each directory (or symlink-to-dir) entry, attempt to derive `FileId` from `metadata()` (follows symlinks). On metadata error, log once per entry to stderr (respecting `warn_logs`) and *skip descending* to avoid cycles via unknown targets.
  - If `FileId` already seen, skip descending (`false`), preventing cycles; otherwise insert and continue.
- Preserve existing error tolerance: entry-level IO errors still print to stderr and continue; cycle skips are silent except for the optional single warning on metadata error.
- Complexity: O(N) memory for visited dirs; only allocated when `--follow-symlinks` is true; zero cost otherwise. Hashing cost unchanged.
- Tests:
  - Unit: self-referential symlink loop on Unix completes with follow_symlinks=true and no hang (duplicate count 0).
  - Unit: metadata error case (symlink pointing to missing target) is handled without panic and traversal completes.
  - Integration (cli): optional future add for cross-platform confidence.

### 2) Progress env semantics
- Change `read_duration_from_env` to return `Option<Duration>`:
  - Parse u64; `0` => `None` (meaning disabled), `>0` => `Some(Duration::from_millis(v))`; invalid/negative => `None` and fallback to defaults at caller.
- `scan_progress_interval()` / `hash_progress_sleep()` return `Option<Duration>`.
- Call sites:
  - During scan, if `scan_interval` is `None`, disable progress output (`progress_allowed` set false, skip timed prints).
  - Hash progress thread: if `hash_sleep` is `None`, do not spawn progress thread (or spawn with a 0-sleep would busy-loop; we skip thread instead).
- Docs: note `0` disables progress; small values allowed.
- Tests:
  - Unit: set env to `0`, ensure no progress thread is spawned/prints but scan still succeeds.
  - Unit: set env to `1`, ensure function returns 1ms (can verify by behavior or accessor).

### 3) Failure surfacing with `--log-level none`
- Introduce `always_warn_on_failures` logic:
  - After the action processing block, if an action was executed *and* `report.failures` is non-empty, emit a single-line summary to stderr regardless of `log_output`, `warn_logs`, `summary_only`, or `summary_silent`.
  - Message format: `Action completed with N failures (first k shown): <path1>, <path2>...; use --summary-path or --log-level warn for details` (k small, e.g., 3) to balance visibility and noise. Include newline and avoid ANSI color to stay machine-friendly.
- Keep existing detailed failure listing under `warn_logs`; `summary_lines` still populated; `summary_path` still written.
- Return code remains success to preserve compatibility; call sites may revisit this later.
- Tests:
  - Unit: force a failure (permission denied move) with `log_level=LogLevel::None`, `summary_silent=true`, no summary_path → capture stderr and assert failure summary present and bounded to k paths.
  - Integration: CLI test using unwritable destination mirrors the unit coverage.

## Data Structures / APIs
- New `FileId` enum encapsulating platform-specific identity and `Hash`/`Eq` impl.
- `VisitedDirs` as `HashSet<FileId>` passed into scan loop; only allocated when needed.
- Progress helpers returning `Option<Duration>`.

## Backward Compatibility
- Default behavior unchanged when env vars unset or positive; only new ability to disable/accelerate progress.
- Additional failure line at `--log-level none` is additive; does not break scripts parsing summaries (text/JSON unchanged).
- Symlink follow remains opt-in; only safer now.

## Telemetry / Observability
- (Optional) Could add `--debug-log-cycles` later; not in scope.

## Testing Plan
- Unit tests (src/main.rs tests module):
  1) `symlink_cycle_no_hang`: create dir A with symlink A/loop -> A; follow_symlinks=true; assert completes and no duplicates.
  2) `progress_env_zero_disables`: env progress=0 and show_progress=true → ensure progress_allowed becomes false (can assert via log capture or flag state).
  3) `log_level_none_failure_surfaces`: create move action to read-only dest to force failure; run with log_level None & summary_silent true; assert stderr contains failure summary.
- Integration tests (tests/cli.rs):
  1) `cli_follow_symlinks_cycle_safe`: same setup, ensure command returns and summary present.
  2) `cli_log_level_none_reports_failures`: unwritable dest, expect stderr summary with “failures”.
- Existing suite: `cargo test` continues to pass.

## Risks & Mitigations
- Platform-specific metadata APIs: guard with cfgs; provide path-based fallback to keep build green on uncommon targets; treat metadata errors as non-fatal and skip descent.
- Performance: canonicalization in cycle detection adds overhead when follow_symlinks used; minimize by only canonicalizing on non-unix/win fallback; default mode unaffected.
- Output noise: failure summary at log-level none adds stderr output; keep concise, no color, limit to k paths; ensure newline to avoid mingling with progress messages.

## Rollout
- Implement behind no flags (default on). Update docs/usage about progress=0 and failure summary behavior. Run full test suite.

## Open Questions
- Should non-zero failure count influence exit code? (Keeping current behavior for now.)
- Limit of paths shown in failure summary? Proposed 3 to avoid noise.
