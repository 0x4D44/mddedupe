# Coverage Improvement Plan — mddedupe (Target ≥ 98 %) — 2025-11-05

## Stage 1 — Pure Helper & Safety Nets (Est. +8 %)
1. Add focused unit tests for:
   - `human_readable` across byte/KB/MB/GB thresholds.
   - `format_duration` minute/second formatting.
   - `get_unique_destination` including stem-only names, extensions, and pre-existing collisions.
2. Extend `process_duplicates` tests to hit:
   - Invalid filename branch (`PathBuf::new()` entry).
   - Destination-collision fallback (`get_unique_destination` invocation).
   - Trash branch logging assertions.
3. Introduce small refactors (helper extraction, internal cfg flags) only where needed to make deterministic assertions possible without altering public behavior.

## Stage 2 — Duplicate Finder Edge Cases (Est. +10 %)
1. Add fixtures that trigger `WalkDir`/metadata errors (chmod 0 on nested dir) and assert graceful logging.
2. Force progress indicator branches by injecting a test-only throttle (e.g., `fn progress_interval() -> Duration` with `#[cfg(test)]` override) to exercise `print!/flush` paths.
3. Expand `test_find_duplicates_optimized` to cover:
   - No-duplicate scenario.
   - Mixed file sizes with >1 duplicate group.
   - Validation of `wasted_space` accumulation and elapsed timing via mocked duration helper.

## Stage 3 — CLI Integration Surface (Est. +9 %)
1. Introduce `run_app(args: Args, input: impl Read, output: impl Write)` (or equivalent) to allow injection of stdin/stdout; keep `main` as thin wrapper.
2. Add integration tests (likely new `tests/` module using `assert_cmd` & `assert_fs`):
   - Baseline read-only run (`--quiet` on/off).
   - `--action delete --force` happy path (covers destructive branch without prompt).
   - Prompted flow (default `force=false`) with simulated “n” (cancel) and “y” (proceed) responses.
   - Invalid `--action` to validate error exit.
   - Missing `--dest` for move action to assert exit path.
3. Validate colorized summary output by capturing stdout and asserting presence of ANSI sequences.

## Stage 4 — Final Polish & Regression Bar (Est. +4 %)
1. Add coverage guard: `cargo llvm-cov --fail-under-lines 98` in CI documentation / Makefile (if present) so regressions fail fast.
2. Review remaining uncovered lines from `cargo llvm-cov --show-missing-lines`; write focused tests or micro-refactors to close any gaps.
3. Maintain test runtime by reusing temp directories and parallel-friendly fixtures; ensure cleanup to keep suite deterministic.
4. Re-run coverage, confirm ≥ 98 %, and document residual exclusions (if any unavoidable).

## Tooling & Dependencies
- Add dev dependencies: `assert_cmd`, `assert_fs`, `predicates`, `tempfile` (already present) to support integration testing.
- Ensure new helpers are gated behind `#[cfg(test)]` when not needed in production builds.
