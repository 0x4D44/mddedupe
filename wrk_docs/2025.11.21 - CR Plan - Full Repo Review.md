# Code Review Plan (2025-11-21)

## Scope & Inventory
- Application code: `src/main.rs` (all logic: CLI, duplicate detection, actions, summaries, cancellation, progress).
- Tests: unit+integration in `src/main.rs` (module) and `tests/cli.rs` (binary CLI flows).
- Configuration: `Cargo.toml`/`Cargo.lock` (deps, features, platform differences), docs for intent (`readme.md`, `ARCHITECTURE.md`, `docs/usage.md`).
- Binaries/artifacts in `target/` excluded.

## Review Goals
- Correctness & functional parity with documented behavior (scan, progress, summaries, actions move/trash/delete, summary-only/quiet/log-level, symlink handling, JSON/text outputs, env-driven timing).
- Safety & data-loss risk (forced deletes/moves, destination handling, trash semantics, cross-device moves, cancellation, broken pipe handling).
- Robustness & error handling (permission errors, IO failures, malformed inputs, ctrl+c, broken pipes, env parsing).
- Concurrency/performance (rayon hashing, shared state, atomic usage, progress thread, memory usage for large trees).
- UX/CLI ergonomics (prompts, quiet/summary flags, log levels, summary path behavior, colored output & TTY expectations).
- Portability (Unix vs Windows paths, trash support, symlink & cross-device handling, system env usage).
- Observability & outputs (summary accuracy, JSON schema stability, exit codes, stdout/stderr separation).
- Test coverage & gaps; verify current test suite with `cargo test`.

## Approach & Steps
1) **Read intent**: skim `readme.md` + `docs/usage.md` for expected behaviors/flags; note promises to validate.
2) **Config scan**: inspect `Cargo.toml` for deps/features/platform conditionals; note safety implications (trash on Windows, libc usage).
3) **Main flow review** (`src/main.rs`):
   - CLI parsing, flag interactions, defaults.
   - Progress/cancellation primitives and env overrides.
   - Duplicate discovery algorithm (size buckets -> hashing) incl. error handling & progress thread.
   - Action pipeline (move/trash/delete) incl. cross-device, unique naming, force/prompt, env-driven trash path.
   - Summary/JSON output logic, logging controls, quiet/summary-only/summary-silent interaction, summary_path writing.
   - Ctrl+C wiring and global state resets.
4) **Tests review**: walk unit tests in `src/main.rs` and integration tests in `tests/cli.rs`; map coverage to behaviors; identify gaps/regressions not covered.
5) **Run suite**: execute `cargo test` (all targets) to confirm current health; capture notable failures/timeouts.
6) **Risk analysis**: enumerate defects/risks by severity with file/line refs; include portability/perf/UX concerns and mitigations.
7) **Recommendations**: propose fixes, test additions, and doc updates; note quick wins vs larger refactors.

## Deliverables
- Review report in `wrk_docs/2025.11.21 - CR - Full Repo Review.md` summarizing findings (severity-tagged), evidence, and recommendations.
- Brief command log (tests run) if applicable.

## Timebox/Order
- Steps 1–4: comprehension (primary focus).
- Step 5: verification run.
- Step 6–7: synthesize findings.
