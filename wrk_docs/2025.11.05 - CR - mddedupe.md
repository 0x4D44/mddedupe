# Code Review – mddedupe (2025-11-05)

## Overview
The project is a CLI tool for scanning directory trees, hashing duplicate-sized files in parallel, and optionally acting on duplicates. The core logic lives in `src/main.rs`; tests are colocated in the same file. Review followed the saved plan and focused on correctness, safety of destructive actions, concurrency, usability, performance characteristics, and maintenance posture.

## Critical Findings
- **High – Trash action is a no-op:** `DuplicateAction::Trash` only logs "simulated" without moving files to the recycle bin, so `--action trash` leaves duplicates untouched while reporting success (src/main.rs:273-276). Users relying on trash for a reversible cleanup will silently be left with duplicate files.

## Significant Issues
- **Medium – Move action fragile across destinations:** Move processing relies on `fs::rename` with no validation that `--dest` exists or is a directory, and it will fail outright on cross-device moves where rename returns `EXDEV` (src/main.rs:258-272, src/main.rs:349-356). The first failure aborts the entire dedupe run mid-stream.
- **Medium – Progress thread can panic on broken stdout:** The hashing progress reporter unwraps `stdout().flush()`, so common scenarios like piping output to `head` will trigger a panic on `EPIPE` (src/main.rs:140-147). That terminates the scan despite the underlying work succeeding.
- **Medium – Duplicate processing aborts on first filesystem error:** Any failure while moving/deleting a single file bubbles up and stops the run, leaving earlier groups half-processed with no summary of what failed (src/main.rs:258-283). There is no continue-on-error or aggregation of failures.

## Additional Observations
- **UX gaps:** Quiet mode suppresses group listings but progress spinners still write to stdout; consider gating progress output behind `--quiet` as well (src/main.rs:118-151, 315-333).
- **Performance/memory:** All candidate hashes are retained in `duplicates`, including unique hashes, which can inflate memory on large trees; consider discarding singleton vectors after aggregation (src/main.rs:153-175).
- **Symlink handling:** `WalkDir` skips symlinks because `file_type().is_file()` is false for them, so linked duplicates are ignored; surface this limitation or add an option (src/main.rs:112-116).
- **Dependency risk:** `ansi_term` (Cargo.toml:11) has been unmaintained for years; consider migrating to `nu-ansi-term` or `yansi` to avoid supply-chain risk.
- **Testing gaps:** Unit tests cover happy paths for hashing and actions but miss validation of failure handling (rename errors, permission-denied deletions, name collisions) and CLI argument enforcement (src/main.rs:395-568).

## Suggested Remediations
1. Implement real trash integration (platform-specific or via a crate) and add tests that confirm duplicates disappear as expected.
2. Harden move/delete flows: validate destination upfront, create missing directories, fall back to copy+delete for cross-device moves, and collect/report per-file errors instead of aborting immediately.
3. Wrap progress output in error handling and suppress it when `--quiet` is set; consider using a logging framework for consistent UX.
4. Drop singleton hash groups to reclaim memory and document symlink behavior or add a flag to include symlinks when desired.
5. Expand tests to cover error conditions and CLI parsing, and replace `ansi_term` with a maintained alternative.

## Testing
- `cargo test` (2025-11-05) – all 5 existing tests pass.
