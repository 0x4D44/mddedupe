# Coverage Improvement Plan - mddedupe
Date: 2026-01-09

## Goal
Achieve >98% code coverage by targeting specific missed branches and error paths identified in the analysis.

## Stages

### Stage 1: Configuration & Environment
*   **Objective:** Verify fallback behavior for progress interval configuration.
*   **Task:** Add a test case that calls `scan_progress_interval` (or a function using it) *without* setting `MDDEDUPE_SCAN_PROGRESS_MS` and without active test overrides. This ensures the `read_duration_from_env` error path (default value) is exercised.

### Stage 2: Symlink Handling
*   **Objective:** Cover missed branches in `filter_entry`.
*   **Task 1 (Symlink to File):** Add a test `test_follow_symlinks_to_file` that creates a symlink pointing to a file and runs with `follow_symlinks: true`. Verify the file is scanned.
*   **Task 2 (Broken Symlink Investigation):** Refine `test_follow_symlinks_missing_target_skips_safely`. Ensure `WalkDir` actually passes the broken entry to the filter and that `metadata()` failure is triggered. If `WalkDir` pre-filters, document it; otherwise, adjust the test to force the failure path.

### Stage 3: IO Error Injection
*   **Objective:** Cover error handling in hashing and directory walking.
*   **Task 1 (Hash Error):** Create `test_hash_file_locked_error` (Windows compatible). Use `fs::File::create` (or `OpenOptions`) to hold an exclusive write lock on a file, then attempt to scan it. Verify the error is logged and the file is skipped (or handled gracefully).
*   **Task 2 (WalkDir Error):** Create `test_scan_unreadable_directory`. Create a directory, restrict read permissions (using `icacls` on Windows or `chmod` on Unix), and verify the scanner handles the `WalkDir` error iteration gracefully.

### Stage 4: Miscellaneous
*   **Objective:** Cover remaining accessible gaps.
*   **Task:** Review `CtrlCStatus` logic. If feasible, simulate a partial failure state to cover the cached error path. (Optional/Low Priority).
