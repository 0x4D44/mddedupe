# mddedupe Coverage Review — 06 Nov 2025

## Measurement Summary
- **Tooling**: `cargo tarpaulin --workspace` (cargo-tarpaulin 0.34.0)
- **Command timestamp**: 2025-11-06 22:47:18 UTC
- **Source files measured**: `src/main.rs`
- **Overall coverage**: **67.30 % (319 / 474 executable lines)**
- **Report artifacts**: `target/tarpaulin/mddedupe-coverage.json` (line-level data) and standard output captured in this session

## Key Findings
1. Coverage is dominated by unit tests embedded in `src/main.rs`; integration tests under `tests/cli.rs` execute a separate instrumented binary so they do not raise coverage for the application logic.
2. Roughly two thirds of uncovered lines sit inside `run_app` (argument validation, summary/JSON emission, failure handling) and the `main` exit-path switch, so improving CLI-focused unit tests will yield the largest gains.
3. Progress-reporting pathways inside `find_duplicates_optimized_with_options` (lines 188–360) remain entirely uncovered because the progress interval never elapses under test; this hides cancellation, broken-pipe, and progress-thread logic.
4. File-manipulation helpers (`write_summary_to_path`, `relocate_file`, `resolve_trash_destination`, `send_to_trash`) and AppError conversions are sparsely exercised even though they guard destructive filesystem operations.
5. There is no coverage of cross-device rename fallbacks, custom trash destinations, summary file writes, or `--summary-format json` with `--summary-path`, leaving observable regressions undetected.

## Gap Analysis by Area
| Area | Uncovered lines | Description | Consequence |
| --- | --- | --- | --- |
| **Progress + cancellation** (`find_duplicates_optimized_with_options`) | 188, 213‑215, 224, 269‑360 | Progress throttling, broken-pipe handling, cancellation short-circuit, worker thread teardown | Regressions could spam progress output or ignore Ctrl‑C without test detection |
| **Reporting helpers** (`ProcessReport::record_failure`, `write_summary_to_path`) | 427, 500‑510 | Failure aggregation and summary file emission | Missed newline/dir creation bugs propagate to CLI without alarms |
| **File relocation/trash helpers** (`relocate_file`, `resolve_trash_destination`, `send_to_trash`) | 546‑560, 567‑608, 625 | Cross-device rename fallback, custom trash path resolution, collision handling | Risk of data loss or crashes when moving/deleting duplicates on different volumes |
| **`run_app` control flow** | 767‑999 | Argument validation, logging level gating, JSON summary serialization, summary-only vs. quiet handling, failure logging | Any regression to user-visible CLI UX would ship untested |
| **`main` error dispatch** | 1002‑1049 | Exit codes/messages for each `AppError` variant | CLI could silently exit with wrong codes without tests |

## Risk Assessment
- **User-facing risk**: High. Most uncovered code directly drives CLI IO (warnings, summary files, JSON output) and file-deletion behavior.
- **Regression detectability**: Low. Integration tests only assert high-level CLI behavior but do not run under Tarpaulin, so they cannot protect these branches.
- **Complexity hot spots**: Progress-thread coordination and cancellation logic interact with global atomics and environment variables; without tests the code is brittle to refactors.

## Immediate Opportunities
1. **Expose configurable progress intervals for tests** so we can deterministically hit the progress-reporting branches (lines 213‑275, 320‑360).
2. **Unit-test filesystem helpers** using temporary directories: cover cross-device copy fallback by simulating an EXDEV rename error and ensure summary files are written with trailing newline + auto-created parents.
3. **Refactor `main` error handling into a helper** that returns an exit-code/message struct; this makes the switch statement testable without invoking `process::exit`.
4. **Add focused `run_app` tests** for: `--summary-format json` + `--summary-path`, `--summary-only` + `--quiet`, `--create-dest` misuse, `summary_lines` failure logging, and `summary_path` writing.
5. **Track coverage after each tranche** (progress logic, helpers, CLI flow) aiming for ≥98% overall (≤10 uncovered lines) by the end of the iteration.
