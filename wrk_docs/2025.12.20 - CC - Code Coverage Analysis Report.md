# Code Coverage Analysis Report

**Date:** 2025-12-20
**Project:** mddedupe v1.1.0
**Tool:** cargo-llvm-cov 0.6.21
**Current Coverage:** 85.93% (1154/1343 lines)
**Target Coverage:** 98%

---

## Executive Summary

The mddedupe codebase has a solid test foundation with 35 tests (25 unit + 10 integration), but significant gaps exist primarily in:
1. The `main()` function error handling branches
2. Platform-specific code paths (macOS, Windows)
3. Edge case error handling in file operations
4. Unused utility functions

To reach 98% coverage (1316/1343 lines), we need to cover approximately **162 additional lines**.

---

## Current Coverage Breakdown

### Well-Covered Areas (90%+)
| Function/Area | Coverage | Notes |
|--------------|----------|-------|
| `human_readable()` | 100% | Full unit test coverage |
| `format_duration()` | 100% | Full unit test coverage |
| `hash_file()` | 100% | Tested with known hash values |
| `get_unique_destination()` | 100% | Collision handling tested |
| `read_duration_from_env()` | 100% | All branches covered |
| `process_duplicates()` | ~95% | Most action types covered |
| `find_duplicates_optimized_with_options()` | ~85% | Core paths covered |

### Under-Covered Areas

#### 1. `main()` Function (lines 1085-1141) - **0% covered**
The main function contains 57 lines of error handling match arms that are never exercised by unit tests because:
- Integration tests run the binary externally
- Unit tests call `run_app()` directly

**Uncovered match arms:**
- `AppError::Io(err)` - line 1091
- `AppError::MissingMoveDestination` - lines 1092-1095
- `AppError::CreateDestRequiresMove` - lines 1096-1099
- `AppError::MoveDestinationNotDirectory` - lines 1100-1103
- `AppError::MoveDestinationMissing` - lines 1104-1110
- `AppError::MoveDestinationCreateFailed` - lines 1111-1118
- `AppError::CtrlCSetup` - lines 1119-1122
- `AppError::Cancelled` - lines 1123-1126
- `AppError::UnknownAction` - lines 1127-1133
- `AppError::ActionFailures` - lines 1134-1140

#### 2. `ansi_rgb()` Function (line 118-120) - **0% covered**
This function is defined but never called in the codebase. It appears to be dead code.

#### 3. Platform-Specific Code in `resolve_trash_destination()` (lines 637-671)
- **macOS path** (lines 644-651): Uses `HOME` env var for `~/.Trash` - not tested on Windows
- **Unix XDG path** (lines 653-659): Uses `XDG_DATA_HOME` - not tested on Windows
- **Unix fallback path** (lines 660-665): Uses `HOME/.local/share/Trash/files` - not tested on Windows
- **Windows Recycle Bin** (line 688): Uses `trash::delete()` - only reachable when MDD_TRASH_DIR is unset

#### 4. Cross-Device Error Handling in `relocate_file()` (lines 622-631)
The cross-device copy fallback is difficult to test without mounting separate filesystems:
- Lines 623-627: Copy, sync, remove source
- Lines 628-631: Copy failure cleanup

#### 5. Error Branches in `run_app()`
| Branch | Lines | Current Coverage |
|--------|-------|------------------|
| `MoveDestinationNotDirectory` | 854-856 | Not tested |
| `MoveDestinationMissing` (without create_dest) | 860-862 | Not tested |
| `MoveDestinationCreateFailed` | 858-859 | Not tested |
| Warning logs for failures | 997-1007 | Partially tested |
| JSON output with action | 1039-1066 | Partially tested |

#### 6. Progress Thread Error Path (line 341)
The `eprintln!` in the hash progress thread is only reachable during rare I/O errors.

#### 7. `write_summary_to_path()` Edge Cases (lines 570-581)
- Parent directory creation logic
- Trailing newline handling

#### 8. `is_cross_device_error()` Function (lines 530-536)
Only tested implicitly through `relocate_file()` which doesn't trigger cross-device scenarios in tests.

---

## Coverage Gap Analysis by Category

### Category A: Easily Testable (Est. 40 lines)
These can be covered with straightforward unit tests:
1. `ansi_rgb()` - either test or remove as dead code
2. `write_summary_to_path()` - add dedicated tests
3. `is_cross_device_error()` - test with synthetic errors
4. `is_broken_pipe()` raw_os_error paths

### Category B: Requires Test Setup (Est. 35 lines)
These need specific file/directory setups:
1. `MoveDestinationNotDirectory` - create file instead of dir
2. `MoveDestinationMissing` - ensure dest doesn't exist, no create_dest
3. `MoveDestinationCreateFailed` - create unwritable parent
4. JSON summary output with actions

### Category C: Platform-Specific (Est. 20 lines)
Conditional compilation means some paths are unreachable on certain platforms:
1. macOS `~/.Trash` path - only testable on macOS
2. Unix XDG trash path - only testable on Unix
3. Windows Recycle Bin - only testable on Windows

### Category D: Hard to Test (Est. 23 lines)
Require special conditions or external factors:
1. Cross-device file operations
2. Progress thread error path
3. `main()` function (consider refactoring for testability)

---

## Recommendations

### Immediate Actions
1. **Remove dead code**: `ansi_rgb()` function is unused
2. **Add missing error path tests**: Easy wins for coverage
3. **Add JSON summary tests**: Test `--summary-format json` with actions

### Medium-Term Actions
1. **Refactor `main()` for testability**: Extract error formatting to testable function
2. **Add platform-specific test conditionals**: Use `#[cfg(test)]` with platform gates
3. **Mock cross-device errors**: Create test helpers for file operation errors

### Long-Term Actions
1. **Consider separating concerns**: Move CLI handling to separate module
2. **Add property-based testing**: Use `proptest` for edge case discovery

---

## Test Statistics

| Category | Count |
|----------|-------|
| Unit tests | 25 |
| Integration tests | 10 |
| Unix-only tests | 6 |
| Windows-only tests | 0 |
| Total tests | 35 |

---

## Appendix: Files Analyzed

- `src/main.rs` - 2,081 lines (1,143 production, 938 test)
- `tests/cli.rs` - 313 lines (integration tests)

---

*Report generated by Claude Code coverage analysis*
