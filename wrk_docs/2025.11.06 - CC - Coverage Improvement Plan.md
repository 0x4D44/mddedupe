# Coverage Improvement Plan — 06 Nov 2025

Goal: Lift `src/main.rs` line coverage from 67.30 % to ≥98 % while de-risking the CLI surfaces most exposed to regression. The work is organized into four incremental stages so we can measure progress and keep the suite green after each tranche.

## Stage 1 — Progress & Cancellation Harness (Target: ≥78 %)
- Add test-only overrides that let us force the scan/hash progress intervals to near-zero without busy loops.
- Exercise `find_duplicates_optimized_with_options` paths for:
  - Progress line emission (lines 213‑238).
  - Hashing progress thread start/stop and graceful cancellation (269‑360).
  - Early cancellation error (line 188) triggered via an injected flag.
- Expected artifacts: new helper behind `#[cfg(test)]`, unit tests verifying ENV override semantics, documented rationale.

## Stage 2 — Filesystem Helper Safety Nets (Target: ≥88 %)
- Add focused tests around `write_summary_to_path`, ensuring parent creation + trailing newline.
- Simulate `fs::rename` returning `EXDEV` to cover the copy‑and‑delete fallback in `relocate_file` (lines 554‑560).
- Cover trash resolution branches:
  - Custom `MDD_TRASH_DIR`.
  - XDG + HOME fallbacks (`resolve_trash_destination`, lines 585‑608).
  - Collision handling in `send_to_trash` (line 625) by pre-creating the destination file.

## Stage 3 — CLI Summary & JSON Surfaces (Target: ≥93 %)
- Extend the in-crate unit tests for `run_app` to cover:
  - `--summary-format json` with `--summary-path` (lines 967‑998).
  - `summary_only`, `quiet`, and `log_level` combinations controlling logging branches (767‑842).
  - Failure logging for `ProcessReport` (929‑947).
  - Read-only flow and summary text branch (949‑954).
- Verify JSON serialization contents and summary file persistence.

## Stage 4 — Error Dispatch & Exit Semantics (Target: ≥98 %)
- Refactor `main`’s `match` into a pure helper (e.g., `fn handle_app_error(err: AppError) -> ExitAction`) so we can assert exit codes/messages without invoking `process::exit`.
- Unit-test each `AppError` variant mapping (lines 1002‑1049) plus the `AppError::from` conversion path (line 649).
- Keep the actual `main` body minimal so the only uncovered instruction is the final `process::exit` call.

## Execution Notes
- After each stage, rerun `cargo tarpaulin --workspace` and record intermediate coverage to confirm the move toward 98 %.
- Favor temporary directories and dependency injection to keep tests hermetic and race-free.
- Integration (`tests/cli.rs`) can remain unchanged; improvements focus on the faster unit suite to keep CI times reasonable.
