# Implementation Plan – Symlink Safety, Progress Controls, Failure Surfacing
Date: 2025-11-21
Owner: Codex
Derived from: `2025.11.21 - HLD - Symlink Safety & Failure Surfacing.md`

## Stage 0 – Prep
- Re-read existing tests and code paths touched: scan loop, progress intervals, action reporting.
- Ensure env clean of MDDEDUPE_* overrides during dev tests unless specified.

## Stage 1 – Symlink Cycle Protection
- Add `FileId` (platform-specific IDs; path fallback) + `VisitedDirs` helper in `src/main.rs`.
- Wire `VisitedDirs` into `find_duplicates_optimized_with_options` only when `follow_symlinks` is true.
- Use `WalkDir::filter_entry` to skip revisiting directories; on metadata error skip descent and optionally log once (respect warn_logs or stderr directly).
- Keep default (no follow_symlinks) path zero-cost.
- Tests:
  - Unit: self-referential symlink loop completes + no hang / duplicate count 0.
  - Unit: missing-target symlink doesn’t panic and traversal completes.

## Stage 2 – Progress Env Semantics
- Change duration helpers to return `Option<Duration>`; 0 => None (disable), >0 exact ms, invalid => default.
- Update scan progress loop to honor None (disable progress) and adjust hash progress thread to not spawn when sleep None.
- Tests:
  - Unit: env=0 disables progress (no progress thread/prints, flag off).
  - Unit: env=1ms respected (observable via returned duration or progress_allowed true).

## Stage 3 – Failure Surfacing at Log Level None
- Add post-action failure summary: when an action ran and failures >0, emit concise stderr line regardless of log_level/summary flags (no ANSI, limit paths to k=3).
- Ensure summary_lines still populated; JSON/text summaries unchanged; exit codes unchanged.
- Tests:
  - Unit: forced failure with log_level None + summary_silent true + no summary_path emits failure summary.
  - Integration (CLI): unwritable dest produces stderr summary mentioning failures.

## Stage 4 – Docs & Help Updates
- Update `readme.md`/`docs/usage.md` to document progress env 0=disabled and failure summary behavior.
- Mention symlink follow now guarded against cycles.

## Stage 5 – Regression & Verification
- Run `cargo fmt` (if style change), `cargo test` (full suite).
- Spot-check `cargo run -- --help` to ensure flag text unchanged.
- Consider `cargo clippy` (optional if time).

## Stage 6 – Wrap-up
- Summarize changes and test results for report/journal if needed.
- Ensure no stray env vars remain.
